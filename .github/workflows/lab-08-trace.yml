name: "Lab 08: Trace GenAI Application"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
  push:
    paths:
      - 'labs/08-tracing/**'
      - '.github/workflows/lab-08-trace.yml'
    branches:
      - main
      - 'lab/08-*'
  pull_request:
    paths:
      - 'labs/08-tracing/**'

env:
  LAB_NAME: "08-tracing"
  LAB_TITLE: "Trace GenAI Application"

jobs:
  trace-genai:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.8+
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install azure-ai-projects azure-identity azure-monitor-opentelemetry azure-ai-inference python-dotenv

    - name: Azure login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set up environment variables
      run: |
        echo "PROJECT_CONNECTION_STRING=${{ secrets.PROJECT_CONNECTION_STRING }}" >> $GITHUB_ENV
        echo "CI_MODE=true" >> $GITHUB_ENV

    - name: Run Lab 08 - Trace GenAI Application
      working-directory: ./labs/08-tracing
      run: |
        echo "::group::Lab Execution"
        python trace_genai.py --ci-mode
        echo "::endgroup::"

    - name: Upload lab results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: lab-08-tracing-results-${{ github.run_id }}
        path: |
          labs/08-tracing/tracing_results.json
        retention-days: 30

    - name: Comment on PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          let resultsContent = 'Lab execution failed - no results file found';
          try {
            const results = JSON.parse(fs.readFileSync('labs/08-tracing/tracing_results.json', 'utf8'));
            
            const summary = results.summary || {};
            resultsContent = `## üîç Lab 08: Trace GenAI Application Results

            **Status:** ${results.status === 'success' ? '‚úÖ Success' : '‚ùå Failed'}
            **Environment:** ${{ github.event.inputs.environment || 'dev' }}
            **Execution Time:** ${new Date().toISOString()}

            ### üî¨ Tracing Results
            - **Tracing Enabled:** ${summary.tracing_enabled ? '‚úÖ' : '‚ùå'}
            - **Content Recording:** ${summary.content_recording_enabled ? '‚úÖ' : '‚ùå'}
            - **Workflows Executed:** ${summary.workflows_executed || 0}
            - **Spans Created:** ${summary.total_spans_created || 0}
            - **Workflow Success Rate:** ${summary.workflow_success_rate || '0%'}
            - **Error Scenarios Traced:** ${summary.error_scenarios_traced || 0}

            ### üèÉ‚Äç‚ôÇÔ∏è Workflow Analysis
            - **Hiking Assistant Workflow:** Multi-step AI workflow with preferences, recommendations, and gear suggestions
            - **Error Scenario Tracing:** Demonstrated error handling and tracing capabilities
            - **Distributed Tracing:** Each step traced with detailed span information
            
            ${results.status === 'failed' ? `
            ### ‚ùå Errors
            \`\`\`
            ${results.error || 'Unknown error occurred'}
            \`\`\`
            ` : ''}

            ### üîó View Traces
            - **Azure AI Foundry:** Check the tracing dashboard in your AI Foundry project
            - **Application Insights:** View detailed distributed traces in Azure Portal
            - **Transaction Search:** Use Application Insights transaction search to find specific traces
            - [Download detailed results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### üìö Next Steps
            1. Open your Azure AI Foundry project
            2. Navigate to the **Tracing** section
            3. Search for traces with your session IDs
            4. Analyze the workflow execution paths
            5. Review error scenarios and debugging information
            `;
          } catch (error) {
            console.error('Error reading results:', error);
          }

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: resultsContent
          });

    - name: Final status check
      if: always()
      run: |
        if [ -f "labs/08-tracing/tracing_results.json" ]; then
          status=$(python -c "import json; print(json.load(open('labs/08-tracing/tracing_results.json')).get('status', 'failed'))")
          if [ "$status" = "success" ]; then
            echo "::notice title=Lab 08 Success::Tracing lab completed successfully! üîç"
            exit 0
          else
            echo "::error title=Lab 08 Failed::Tracing lab failed. Check logs for details."
            exit 1
          fi
        else
          echo "::error title=Lab 08 Failed::No results file found."
          exit 1
        fi